---
title: "Creating custom themes"
output: html_document
---

```{r opts}
knitr::opts_chunk$set(
  fig.width = 8, fig.asp = 0.618,
  fig.retina = 2, dpi = 150
)
```

```{r packages}
library(tidyverse)
library(here)
library(gapminder)  # For gapminder data
library(colorspace) # For color scales
library(scales)     # For improved labels
```

# Basic plot

```{r basic-plot}
gapminder_filtered <- gapminder %>% 
  filter(year > 2000)

base_plot <- ggplot(data = gapminder_filtered,
                    mapping = aes(x = gdpPercap, y = lifeExp, 
                                  color = continent, size = pop)) +
  geom_point() +
  # Use dollars, and get rid of the cents part (i.e. $300 instead of $300.00)
  scale_x_log10(labels = dollar_format(accuracy = 1)) +
  # Format with commas
  scale_size_continuous(labels = comma) +
  # Use dark 3
  scale_color_discrete_qualitative(palette = "Dark 3") +
  labs(x = "GDP per capita", y = "Life expectancy",
       color = "Continent", size = "Population",
       title = "Here's a cool title",
       subtitle = "And here's a neat subtitle",
       caption = "Source: The Gapminder Project") +
  facet_wrap(vars(year))

base_plot
```

Now we have `base_plot` to work with. Here's what it looks like with `theme_minimal()` applied to it:

```{r base-minimal}
base_plot +
  theme_minimal()
```

That gets rid of the grey background and is a good start, but we can make lots of improvements. First let's deal with the gridlines. There are too many. We can get rid of the minor gridlines with by setting them to `element_blank()`:

```{r theme1}
base_plot +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())
```

Next let's add some typographic contrast. We'll use Roboto Condensed Regular as the base font. Before trying this, make sure you do the following:

**On macOS**:

- Run `capabilities()` in your console and verify that `TRUE` shows up under `cairo`
- If not, download and install [XQuartz](https://www.xquartz.org/)

**On Windows**:

- Run `windowsFonts()` in your console and you'll see a list of all the fonts you can use with R. It's not a very big list.

    ```text
    #> $serif
    #> [1] "TT Times New Roman"
    #>
    #> $sans
    #> [1] "TT Arial"
    #> 
    #> $mono
    #> [1] "TT Courier New"
    ```
    
    You can add Roboto Condensed to your current R session by running this in your console:

    ```{r windowsfonts, eval=FALSE}
    windowsFonts(`Roboto Condensed` = windowsFont("Roboto Condensed"))
    ```

    Now if you run `windowsFonts()`, you'll see it in the list:
    
    ```text
    #> $serif
    #> [1] "TT Times New Roman"
    #>
    #> $sans
    #> [1] "TT Arial"
    #> 
    #> $mono
    #> [1] "TT Courier New"
    #>
    #> $`Roboto Condensed`
    #> [1] "Roboto Condensed"
    ```

    This only takes effect for your current R session, so if you are knitting a document or if you ever plan on closing RStudio, you'll need to incorporate this font creation code into your script.

We'll use the font as the `base_family` argument. Note how I make it bold with `face` and change the size with `rel()`. Instead of manually setting some arbitrary size, I use `rel()` to resize the text in relation to the `base_size` argument. Using `rel(1.7)` means 1.7 × `base_size`, or 20.4 That will rescale according to whatever `base_size` is—if I shrink it to `base_size = 8`, the title will scale down accordingly.

```{r theme2}
plot_with_good_typography <- base_plot +
  theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        # Bold, bigger title
        plot.title = element_text(face = "bold", size = rel(1.7)),
        # Plain, slightly bigger subtitle that is grey
        plot.subtitle = element_text(face = "plain", size = rel(1.3), color = "grey70"),
        # Italic, smaller, grey caption that is left-aligned
        plot.caption = element_text(face = "italic", size = rel(0.7), 
                                    color = "grey70", hjust = 0),
        # Bold legend titles
        legend.title = element_text(face = "bold"),
        # Bold, slightly larger facet titles that are left-aligned for the sake of repetition
        strip.text = element_text(face = "bold", size = rel(1.1), hjust = 0),
        # Bold axis titles
        axis.title = element_text(face = "bold"),
        # Add some space above the x-axis title and make it left-aligned
        axis.title.x = element_text(margin = margin(t = 10), hjust = 0),
        # Add some space to the right of the y-axis title and make it top-aligned
        axis.title.y = element_text(margin = margin(r = 10), hjust = 1))
plot_with_good_typography
```

Whoa. That gets us most of the way there! We have good contrast with the typography, with the strong bold and the lighter regular font (**✓ contrast**). Everything is aligned left (**✓ alignment** and **✓ repetition**). By moving the axis titles a little bit away from the labels, we've enhanced proximity, since they were too close together (**✓ proximity**). We repeat grey in both the caption and the subtitle (**✓ repetition**).

The only thing I don't like is that the 2002 isn't quite aligned with the title and subtitle. This is because the facet labels are in boxes along the top of each plot, and in some themes (like `theme_grey()` and `theme_bw()`) those facet labels have grey backgrounds. We can turn off the margin in those boxes, or we can add a background, which will then be perfectly aligned with the title and subtitle.

```{r theme3}
plot_with_good_typography +
  # Add a light grey background to the facet titles, with no borders
  theme(strip.background = element_rect(fill = "grey90", color = NA),
        # Add a thin grey border around all the plots to tie in the facet titles
        panel.border = element_rect(color = "grey90", fill = NA))
```

`r emo::ji("chef")` `r emo::ji("kiss")`! That looks great!

To save ourselves time in the future, we can store this whole thing as an object that we can then reuse on other plots:

```{r theme-store}
my_pretty_theme <- theme_minimal(base_family = "Roboto Condensed", base_size = 12) +
  theme(panel.grid.minor = element_blank(),
        # Bold, bigger title
        plot.title = element_text(face = "bold", size = rel(1.7)),
        # Plain, slightly bigger subtitle that is grey
        plot.subtitle = element_text(face = "plain", size = rel(1.3), color = "grey70"),
        # Italic, smaller, grey caption that is left-aligned
        plot.caption = element_text(face = "italic", size = rel(0.7), 
                                    color = "grey70", hjust = 0),
        # Bold legend titles
        legend.title = element_text(face = "bold"),
        # Bold, slightly larger facet titles that are left-aligned for the sake of repetition
        strip.text = element_text(face = "bold", size = rel(1.1), hjust = 0),
        # Bold axis titles
        axis.title = element_text(face = "bold"),
        # Add some space above the x-axis title and make it left-aligned
        axis.title.x = element_text(margin = margin(t = 10), hjust = 0),
        # Add some space to the right of the y-axis title and make it top-aligned
        axis.title.y = element_text(margin = margin(r = 10), hjust = 1),
        # Add a light grey background to the facet titles, with no borders
        strip.background = element_rect(fill = "grey90", color = NA),
        # Add a thin grey border around all the plots to tie in the facet titles
        panel.border = element_rect(color = "grey90", fill = NA))
```

Now we can use it on any plot. Remember that first plot you made in your exercise from session 1 with the `cars` dataset? Let's throw this theme on it! (only here the dataset is named `mpg` instead of `cars`; the `mpg` dataset is loaded invisibly whenever you load ggplot)

```{r mpg-example}
library(palmerpenguins)

penguins_example <- ggplot(data = drop_na(penguins, sex), 
                      mapping = aes(x = bill_length_mm, y = body_mass_g, color = str_to_title(sex))) +
  geom_point(size = 3) + 
  scale_color_discrete_qualitative(palette = "Dark 3") +
  scale_y_continuous(labels = label_comma()) +
  facet_wrap(vars(species)) +
  labs(x = "Bill length (mm)", y = "Body mass (g)", color = "Sex",
       title = "Gentoo penguins are the largest",
       subtitle = "But females are typically smaller than males",
       caption = "Here's a caption") +
  my_pretty_theme

penguins_example
```

Super neat!
